--[[
    ██████╗ ███████╗ █████╗ ██╗     ████████╗██╗  ██╗
    ██╔══██╗██╔════╝██╔══██╗██║     ╚══██╔══╝██║  ██║
    ██████╔╝█████╗  ███████║██║        ██║   ███████║
    ██╔══██╗██╔══╝  ██╔══██║██║        ██║   ██╔══██║
    ██║  ██║███████╗██║  ██║███████╗   ██║   ██║  ██║
    ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝   ╚═╝   ╚═╝  ╚═╝
    STEALTH RECOIL CONTROL v3.2 - SMOOTH HORIZONTAL
--]]

EnableRCS = true
RecoilControlMode = "High"
RcCustomStrength = 7
RequireToggle = true
ToggleKey = "CapsLock"
DelayRate = 7

-- VERTICAL RECOIL
Humanize = true
RandomnessEnabled = true
RandomRange = 2
MicroPauseChance = 8
MicroPauseMax = 3

-- ★ SMOOTH & WEAK HORIZONTAL ★
HorizontalRecoilEnabled = true
HorizontalRange = 2               -- ±2px (HEIKOMPI!)
HorizontalChance = 30             -- 30% (HARVEMMIN!)
HorizontalStrengthVariation = 1   -- Pieni vaihtelu
HorizontalSmoothing = true        -- Sujuvuus PÄÄLLÄ!

-- ADVANCED STEALTH (ENEMMÄN SUJUVUUTTA)
EnableMouseEventSpoof = true
MovementCurve = "easeOut"
SmoothingSteps = 5                -- 5 osaa = SUPER SUJUVA!

-- PRESETS
local BaseStrength = 0
if RecoilControlMode == "Low" then BaseStrength = 2
elseif RecoilControlMode == "Medium" then BaseStrength = 6
elseif RecoilControlMode == "High" then BaseStrength = 8
elseif RecoilControlMode == "Ultra" then BaseStrength = 12
elseif RecoilControlMode == "Insanity" then BaseStrength = 31
elseif RecoilControlMode == "Custom" then BaseStrength = RcCustomStrength
end

EnablePrimaryMouseButtonEvents(true)

-- Easing functions (sujuvampi)
local function easeOut(t) return 1 - (1 - t) ^ 3 end
local function easeIn(t) return t ^ 2 end
local function sine(t) return 0.5 - 0.5 * math.cos(t * math.pi) end

-- ★ ULTRA-SMOOTH MOUSE MOVE ★
local function MoveMouseSmooth(x, y, steps)
    if not EnableMouseEventSpoof then
        MoveMouseRelative(x, y)
        return
    end

    local curveFunc = easeOut
    if MovementCurve == "easeIn" then curveFunc = easeIn
    elseif MovementCurve == "sine" then curveFunc = sine
    end

    -- EXTRA SUJUVUUS HORIZONTALILLE
    if HorizontalSmoothing and math.abs(x) > 0 then
        steps = steps + 1  -- 6 osaa pienille liikkeille
    end

    local totalX, totalY = 0, 0
    for i = 1, steps do
        local t = i / steps
        local eased = curveFunc(t)
        local dx = math.floor(x * eased + 0.5)
        local dy = math.floor(y * eased + 0.5)
        
        totalX = totalX + dx
        totalY = totalY + dy
        
        if dx ~= 0 or dy ~= 0 then
            MoveMouseRelative(dx, dy)
            Sleep(1)
        end
    end
    
    -- Debug: print("Moved: X=" .. totalX .. " Y=" .. totalY) -- Poista tämä!
end

function OnEvent(event, arg)
    if not EnableRCS then return end
    if RequireToggle and not IsKeyLockOn(ToggleKey) then return end
    if not IsMouseButtonPressed(3) then return end

    repeat
        if IsMouseButtonPressed(1) then
            repeat
                local vertStrength = BaseStrength
                local horizStrength = 0

                -- 1. VERTICAL
                if RandomnessEnabled and math.random(1, 100) <= 85 then
                    local offset = math.random(-RandomRange, RandomRange)
                    vertStrength = vertStrength + offset
                    if vertStrength < 1 then vertStrength = 1 end
                end

                -- ★ 2. SMOOTH WEAK HORIZONTAL ★
                if HorizontalRecoilEnabled and math.random(1, 100) <= HorizontalChance then
                    local baseHoriz = math.random(-HorizontalRange, HorizontalRange)
                    if baseHoriz ~= 0 then
                        local variation = math.random(-HorizontalStrengthVariation, HorizontalStrengthVariation)
                        horizStrength = baseHoriz + variation
                        
                        -- MINIMI 1px suuntaan
                        if math.abs(horizStrength) < 1 then 
                            horizStrength = horizStrength > 0 and 1 or -1 
                        end
                    end
                end

                -- 3. MIKROTAUKO
                if MicroPauseChance > 0 and math.random(1, 100) <= MicroPauseChance then
                    Sleep(math.random(1, MicroPauseMax))
                end

                -- 4. ULTRA-SMOOTH LIIKE
                if Humanize then
                    MoveMouseSmooth(horizStrength, vertStrength, SmoothingSteps)
                else
                    MoveMouseRelative(horizStrength, vertStrength)
                end

                Sleep(DelayRate + math.random(0, 2))

            until not IsMouseButtonPressed(1)
        end
        Sleep(1)
    until not IsMouseButtonPressed(3)
end
